@using Blogzaur.Application.BlogEntry.Commands.EditBlogEntry

@model EditBlogEntryCommand

<head>
    <link rel="stylesheet" href="~/css/create.css" asp-append-version="true" />
</head>

<h1 class="margin-large" align="center">Edit Blog Entry</h1>

<div class="col-xs-1" align="center">
    <div class="col-md-4 w-75">
        <form asp-action="Edit" method="post">
            <input type="hidden" asp-for="Id" />
            <div class="form-group mb-3 w-50">
                <label class="control-label small-header" for="Title">Title</label>
                <textarea type="text" class="title-input form-control margin-small" placeholder="Write your title here" asp-for="Title"></textarea>
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>
            <div class="form-group mb-3 w-50">
                <label class="control-label small-header" for="Description">Description</label>
                <div>
                    <textarea id="description" type="text" class="description form-control margin-small" placeholder="Write your description here" asp-for="Description"></textarea>
                    <div id="char-counter" class="char-counter"></div>
                </div>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            @* Category UI (same UX as Create.cshtml) *@
            <div class="form-group mb-3 w-25">
                <label class="control-label small-header" for="categorySelect">Categories</label>
                <select id="categorySelect" class="form-select margin-small">
                    <option value="">Select category...</option>
                    @foreach (var category in ViewBag.Categories as List<SelectListItem> ?? new List<SelectListItem>())
                    {
                        <option value="@category.Value">@category.Text</option>
                    }
                </select>

                <div id="selectedCategories" class="mt-2">
                    @* Pre-render existing selected categories as hidden inputs + removable badges,
                       matching the markup that client-side code uses when adding categories in Create. *@
                    @{
                        var categories = ViewBag.Categories as List<SelectListItem> ?? new List<SelectListItem>();
                        if (Model?.CategoryIds != null && Model.CategoryIds.Any())
                        {
                            foreach (var id in Model.CategoryIds)
                            {
                                var text = categories.FirstOrDefault(c => c.Value == id.ToString())?.Text ?? id.ToString();
                                <input type="hidden" name="CategoryIds" value="@id" />
                                <span class="badge bg-secondary me-1 selected-category" data-id="@id">
                                    @text
                                    <button type="button" class="btn-close btn-close-white btn-sm ms-2 remove-category" aria-label="Remove" data-id="@id"></button>
                                </span>
                            }
                        }
                    }
                </div>
            </div>

            <div class="main-content w-100">
                <div class="text-editor-header">
                    <button type="button" class="btn btn-editor" data-element="bold">
                        <i class="fa fa-bold"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="italic">
                        <i class="fa fa-italic"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="underline">
                        <i class="fa fa-underline"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="insertUnorderedList">
                        <i class="fa fa-list-ul"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="insertOrderedList">
                        <i class="fa fa-list-ol"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="createLink">
                        <i class="fa fa-link"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="justifyLeft">
                        <i class="fa fa-align-left"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="justifyCenter">
                        <i class="fa fa-align-center"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="justifyRight">
                        <i class="fa fa-align-right"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="justifyFull">
                        <i class="fa fa-align-justify"></i>
                    </button>
                    <button type="button" class="btn btn-editor" data-element="insertImage">
                        <i class="fa fa-image"></i>
                    </button>
                </div>
                <div class="form-group mb-3">
                    <input type="hidden" asp-for="Content" />
                    <div class="form-control content" contenteditable="true" data-text="Write your blog here"></div>
                    <span asp-validation-for="Content" class="text-danger"></span>
                </div>
            </div>
            <div class="form-group mb-3">
                <input type="submit" class="btn btn-primary" value="Save Changes" />
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://use.fontawesome.com/a31a3f8384.js"></script>
    <script src="~/js/BlogEntry/Create.js"></script>
    <script src="~/js/BlogEntry/Edit.js"></script>
    @* Inline fallback script to ensure removal works if bootstrap btn-close styling isn't available *@
    <script>
        // allow keyboard-accessible removal if needed
        document.addEventListener('click', function (e) {
            if (e.target && (e.target.classList.contains('remove-category') || e.target.closest('.remove-category'))) {
                e.preventDefault();
                var btn = e.target.closest('.remove-category');
                var id = btn.getAttribute('data-id');
                if (!id) return;
                // remove hidden input(s) with this value
                var inputs = document.querySelectorAll('input[name="CategoryIds"][value="' + id + '"]');
                inputs.forEach(i => i.remove());
                // remove badge
                var badge = btn.closest('.selected-category');
                if (badge) badge.remove();
            }
        });
    </script>
}